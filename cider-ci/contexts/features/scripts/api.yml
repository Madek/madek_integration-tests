precompile-api:
  exclusive-executor-resource: precompile-madek-api
  body: |
    #!/usr/bin/env bash
    set -eux
    cd api
    ./cider-ci/bin/compile_uberjar.sh

run-api:
  body: |
    set -eux
    cd api
    export JAVA_HOME=${OPENJDK8_HOME}
    export PATH=${JAVA_HOME}/bin:${PATH}
    export CLASSPATH="../config:target/api.jar"
    java madek.api.main
  start-when:
    - script: create-database
    - script: precompile-api
  terminate-when:
    - script: shutdown-api
      states: [aborted, passed, failed, skipped]

api-is-running:
  body: |
    set -eux
    until curl --silent --fail --user x:secret -I  http://localhost:${API_HTTP_PORT}/api; do sleep 1; done
  start-when:
  - script: run-api
    states: [executing]
  terminate-when:
    - script: shutdown-api
      states: [aborted, passed, failed, skipped]

shutdown-api:
  body: |
    set -eux
    curl -X POST --silent --fail --user x:secret -I  http://localhost:${API_HTTP_PORT}/api/management/shutdown
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]

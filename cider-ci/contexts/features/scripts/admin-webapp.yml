run-admin-webapp:
  body: |
    set -eux
    cd admin-webapp
    export PATH=$(pwd)/vendor/jruby/bin/:$(ruby -e "puts ENV['PATH'].split(':').reject{|s| s.match(/\.rbenv/)}.join(':')")
    bundle exec rails s -p  ${ADMIN_WEBAPP_HTTP_PORT}
  start-when:
    - script: create-database
  terminate-when:
    - script: shutdown-admin-webapp
      states: [aborted, failed, passed, skipped]


admin-webapp-is-running:
  body: |
    set -eux
    until curl --silent --fail  -I  http://localhost:${ADMIN_WEBAPP_HTTP_PORT}/admin/status; do sleep 1; done
  start-when:
    - script: run-admin-webapp
      states: [executing]
  terminate-when:
    - script: shutdown-admin-webapp
      states: [aborted, failed, passed, skipped]


shutdown-admin-webapp:
  timeout: 5 Seconds
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${ADMIN_WEBAPP_HTTP_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]

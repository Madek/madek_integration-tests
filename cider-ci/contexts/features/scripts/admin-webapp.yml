admin-webapp-bundle-mri:
  exclusive-executor-resource: bundler-mri
  body: |
    set -eux
    cd admin-webapp
    ./bin/bundle_with_cachestamp.sh

admin-webapp-bundle-jruby:
  exclusive-executor-resource: bundler-jruby
  environment-variables:
    RBENV_VERSION: jruby-9000
  body: |
    set -eux
    cd admin-webapp
    ./bin/bundle_with_cachestamp.sh

admin-webapp-precompile-assets:
  body: |
    set -eux
    cd admin-webapp
    ./cider-ci/bin/precompile-assets-with-caching.sh
  start-when:
    - script: admin-webapp-bundle-mri

run-admin-webapp:
  environment-variables:
    RBENV_VERSION: jruby-9000
  body: |
    set -eux
    cd admin-webapp
    bundle exec rails s -p  ${ADMIN_WEBAPP_HTTP_PORT}
  start-when:
    - script: create-database
    - script: admin-webapp-bundle-jruby
    - script: admin-webapp-precompile-assets
  terminate-when:
    - script: shutdown-admin-webapp
      states: [aborted, failed, passed, skipped]


admin-webapp-is-running:
  body: |
    set -eux
    until curl --silent --fail  -I  http://localhost:${ADMIN_WEBAPP_HTTP_PORT}; do sleep 1; done
  start-when:
    - script: run-admin-webapp
      states: [executing]
  terminate-when:
    - script: shutdown-admin-webapp
      states: [aborted, failed, passed, skipped]


shutdown-admin-webapp:
  timeout: 5 Seconds
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${ADMIN_WEBAPP_HTTP_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]

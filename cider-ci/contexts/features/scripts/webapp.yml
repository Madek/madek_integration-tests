webapp-bundle-mri:
  exclusive-executor-resource: bundler-mri
  body: |
    set -eux
    cd webapp
    ./bin/bundle_with_cachestamp.sh

webapp-bundle-jruby:
  exclusive-executor-resource: bundler-jruby
  environment-variables:
    RBENV_VERSION: jruby-9000
  body: |
    set -eux
    cd webapp
    ./bin/bundle_with_cachestamp.sh

webapp-precompile-assets:
  body: |
    set -eux
    cd webapp
    ./bin/precompile-assets-with-caching.sh
  start-when:
    - script: configure
    - script: webapp-bundle-mri

run-webapp:
  environment-variables:
    RBENV_VERSION: jruby-9000
  body: |
    set -eux
    cd webapp
    bundle exec rails s -p  ${WEBAPP_HTTP_PORT}
  start-when:
    - script: configure
    - script: create-database
    - script: webapp-bundle-jruby
    - script: webapp-precompile-assets
  terminate-when:
    - script: shutdown-webapp
      states: [aborted, failed, passed, skipped]


webapp-is-running:
  body: |
    set -eux
    until curl --silent --fail  -I  http://localhost:${WEBAPP_HTTP_PORT}; do sleep 1; done
  start-when:
    - script: run-webapp
      states: [executing]
  terminate-when:
    - script: shutdown-webapp
      states: [aborted, failed, passed, skipped]


shutdown-webapp:
  timeout: 5
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${WEBAPP_HTTP_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]

run-webapp:
  body: |
    set -eux
    cd webapp
    export PATH=$(pwd)/vendor/jruby/bin/:$(ruby -e "puts ENV['PATH'].split(':').reject{|s| s.match(/\.rbenv/)}.join(':')")
    bundle exec rails s -p  ${WEBAPP_HTTP_PORT}
  start-when:
    - script: create-database
  terminate-when:
    - script: shutdown-webapp
      states: [aborted, failed, passed, skipped]


webapp-is-running:
  body: |
    set -eux
    until curl --silent --fail  -I  http://localhost:${WEBAPP_HTTP_PORT}; do sleep 1; done
  start-when:
    - script: run-webapp
      states: [executing]
  terminate-when:
    - script: shutdown-webapp
      states: [aborted, failed, passed, skipped]


shutdown-webapp:
  timeout: 5 Seconds
  body: |
    set -eux
    kill -INT $(lsof -t -wni tcp:${WEBAPP_HTTP_PORT})
    sleep 1
  start-when:
    - script: test
      states: [aborted, passed, failed, skipped]

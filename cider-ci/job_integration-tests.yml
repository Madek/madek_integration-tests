integration-tests:

  name: Integration-Tests

  description: |
    This job runs the top level integration tests.  It must be run from
    the master project.

  depends-on:
    - type: job
      job: all-tests
      submodule: ['webapp']
      states: [passed]
    - type: job
      job: all-tests
      submodule: ['api']
      states: [passed]
    - type: job
      job: build-docs
      submodule: ['documentation']
      states: [passed]

  run-on:
    - type: branch
      include-match: ^.*$

  context:

    task-defaults:

      git-options:
        submodules:
          clone:
            exclude-match: deploy
          timeout: 60
      max-auto-trials: 1

      traits:
        bash: true
        git: true
        linux: true
        ruby: true
        rbenv: true

      environment-variables:
        RBENV_VERSION: '2.2.4'

    subcontexts:

      - name: Features

        _cider-ci_include: cider-ci/contexts/features/defaults.yml

        _cider-ci_generate-tasks:
          include-match: spec/features/.*_spec.rb


      - name: Unit


        _cider-ci_include: cider-ci/contexts/unit_defaults.yml

        _cider-ci_generate-tasks:
          include-match: spec/unit/.*_spec.rb
